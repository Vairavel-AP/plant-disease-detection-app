<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plant Disease Classification</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container zoom-in">
    <h1 class="floating">ðŸŒ± Plant Disease Classification</h1>
    <p>Upload an Image for Prediction</p>

    <!-- Upload Form -->
    <form id="upload-form" enctype="multipart/form-data">
      <label class="upload-btn">
        Choose Image
        <input type="file" name="image" id="image-input" accept="image/*" required>
      </label>
      <button type="submit" class="btn glow">Submit</button>
    </form>

    <!-- Preview uploaded image -->
    <div id="preview" class="fade-in hidden">
      <h2>Uploaded Image</h2>
      <img id="preview-img" src="" alt="Preview" />
    </div>

    <!-- Prediction Card -->
    <div id="prediction" class="card hidden slide-up">
      <h2>Predicted Disease: <span id="predicted-class"></span></h2>
      <p>Confidence: <span id="confidence"></span></p>
      <button id="precautions-btn" class="btn">Give Precautions</button>
    </div>

    <!-- Precautions -->
    <div id="precautions" class="card hidden fade-in">
      <h2>Precautions</h2>
      <div id="precautions-list"></div>
    </div>

    <!-- Error Message -->
    <p id="error" class="error"></p>
  </div>

  <!-- Footer -->
  <div class="footer">
    <img src="{{ url_for('static', filename='vairavel.png') }}" alt="Vairavel">
    <p>Created by <strong>Vairavel</strong></p>
  </div>

  <script>
    const form = document.getElementById("upload-form");
    const predictionCard = document.getElementById("prediction");
    const predictedClassEl = document.getElementById("predicted-class");
    const confidenceEl = document.getElementById("confidence");
    const precautionsBtn = document.getElementById("precautions-btn");
    const precautionsDiv = document.getElementById("precautions");
    const precautionsList = document.getElementById("precautions-list");
    const errorEl = document.getElementById("error");
    const previewDiv = document.getElementById("preview");
    const previewImg = document.getElementById("preview-img");
    const imageInput = document.getElementById("image-input");

    // Show image preview
    imageInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewDiv.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // Handle form submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorEl.textContent = "";

      const formData = new FormData(form);
      try {
        const res = await fetch("/predict", { method: "POST", body: formData });
        const data = await res.json();

        if (data.error) {
          errorEl.textContent = "Error: " + data.error;
        } else {
          predictedClassEl.textContent = data.predicted_class;
          confidenceEl.textContent = (data.confidence * 100).toFixed(2) + "%";
          predictionCard.classList.remove("hidden");
        }
      } catch {
        errorEl.textContent = "Error: Failed to connect to server.";
      }
    });

    // Handle precautions
    // Handle precautions
    precautionsBtn.addEventListener("click", async () => {
      precautionsBtn.disabled = true;
      try {
        const res = await fetch("/get_precautions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ predicted_class: predictedClassEl.textContent }),
        });
        const data = await res.json();

        precautionsList.innerHTML = "";
        if (data.error) {
          precautionsList.innerHTML = "<p class='error'>Error: " + data.error + "</p>";
        } else {
          for (const [key, value] of Object.entries(data)) {
            const box = document.createElement("div");
            box.className = "precaution-box slide-up";

            // Split by new lines only (cleaner separation)
            const points = value
              .split(/\n+/)
              .map(p => p.replace(/^\d+[\.\)]\s*/, "").trim()) // remove unwanted numbering
              .filter(p => p.length > 0);

            // Build list with âœ” icons
            let listHTML = `<div class="precaution-list">`;
            points.forEach(p => {
              listHTML += `<p class="precaution-item"> ${p}</p>`;
            });
            listHTML += "</div>";

            // Highlight subsection titles
            box.innerHTML = `<h3 class="precaution-title">${key}</h3>${listHTML}`;
            precautionsList.appendChild(box);
          }
          precautionsDiv.classList.remove("hidden");
        }
      } catch {
        precautionsList.innerHTML = "<p class='error'>Error: Failed to fetch precautions.</p>";
      }
      precautionsBtn.disabled = false;
    });

  </script>
</body>

</html>